name: Dependency Update

on:
  schedule:
    - cron: '0 0 * * MON' # Every Monday at midnight
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  dependency-update:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Check for dependency updates
        run: |
          # Check for outdated packages
          pnpm outdated --format json > outdated.json || true
          
          # If no updates available, exit gracefully
          if [ ! -s outdated.json ] || [ "$(cat outdated.json)" = "{}" ]; then
            echo "No dependency updates available"
            exit 0
          fi
          
          # Show what would be updated
          echo "ðŸ“¦ Available dependency updates:"
          pnpm outdated
          
      - name: Update dependencies
        run: |
          # Update all workspace dependencies recursively
          pnpm update -r --latest
          
      - name: Run quality checks after update
        run: |
          pnpm install --frozen-lockfile
          pnpm run quality
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ðŸ“¦ Automated dependency update'
          body: |
            ## Automated Dependency Update
            
            This PR updates the project dependencies to their latest compatible versions.
            
            ### Changes
            - Updated npm dependencies to latest versions
            - All quality checks passing
            
            ### Quality Assurance
            - âœ… Code formatting check passed
            - âœ… ESLint checks passed  
            - âœ… TypeScript type checking passed
            - âœ… All tests passing with coverage
            
            This PR was created automatically by the dependency update workflow.
          branch: chore/dependency-update
          delete-branch: true
